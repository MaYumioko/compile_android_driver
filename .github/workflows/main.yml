name: Android Kernel Driver Builder (Specific Version)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version'
        required: true
        default: '15'
      kernel_version:
        description: 'Kernel Branch Version (e.g., 6.6)'
        required: true
        default: '6.6'
      target_tag:
        description: 'Specific Kernel Tag (e.g., v6.6.102)'
        required: true
        default: 'v6.6.102'
      driver_name:
        description: 'Driver Module Name'
        required: true
        default: 'hwBreakpointProc.ko'
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Free Disk Space
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 1

      - name: Prepare kerneldriver
        run: |
          if [ ! -d "./code" ]; then echo "::error::./code not found"; exit 1; fi
          mkdir kerneldriver
          cp -r ./code/* kerneldriver/

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git curl

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Initialize Repo (Manifest)
        run: |
          mkdir -p android-kernel && cd android-kernel
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          BRANCH="common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}"
          echo "Initializing Manifest Branch: $BRANCH"
          
          repo init -u https://android.googlesource.com/kernel/manifest -b "$BRANCH" --depth=1
          repo sync -c -j$(nproc) --no-tags --optimized-fetch

      - name: Checkout Specific Kernel Version
        run: |
          cd android-kernel/common
          
          TARGET="${{ github.event.inputs.target_tag }}"
          echo "Switching Kernel Source to: $TARGET"
          
          # 尝试 Fetch Tag 或 Commit ID
          git fetch https://android.googlesource.com/kernel/common "refs/tags/$TARGET" --depth=1 || \
          git fetch https://android.googlesource.com/kernel/common "$TARGET" --depth=1
          
          git checkout FETCH_HEAD
          
          echo "Current Kernel Head:"
          git show --oneline -s

      - name: Integrate Driver & Configure
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers/
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile
          
          # 注册模块 (Android 15)
          if [ -f "common/modules.bzl" ]; then
             sed -i "/_COMMON_GKI_MODULES_LIST = \[/a \    \"drivers/kerneldriver/${{ github.event.inputs.driver_name }}\"," common/modules.bzl
          fi
          
          # 增加栈大小
          find common -name "Makefile" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +

      - name: Build Kernel (Bazel)
        run: |
          cd android-kernel
          echo "Building for tag: ${{ github.event.inputs.target_tag }}"
          
          # Bazel 构建
          tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist \
            -- --dist_dir=out/dist --allow_undeclared_modules --lto=thin

      - name: Locate Artifacts
        id: locate
        if: always()
        run: |
          cd android-kernel
          mkdir -p final_output
          find . -type f -name "*.ko" -exec cp -v {} final_output/ \;
          find out/dist -type f -name "System.map" -exec cp -v {} final_output/ \; || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          # 修复: 移除 target_tag 变量，改用固定名称，避免非法字符导致 YAML 错误
          # 你可以在下载后的压缩包里查看具体版本
          name: "kernel-driver-build-result"
          path: "android-kernel/final_output/*"
