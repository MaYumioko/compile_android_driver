name: Android Kernel Driver Builder (Specific Version)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version'
        required: true
        default: '15'
      kernel_version:
        description: 'Kernel Branch Version (e.g., 6.6)'
        required: true
        default: '6.6'
      target_tag:
        description: 'Specific Kernel Tag/Version (e.g., v6.6.102)'
        required: true
        default: 'v6.6.102'
      driver_name:
        description: 'Driver Module Name'
        required: true
        default: 'hwBreakpointProc.ko'
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Free Disk Space
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean

      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 1

      - name: Prepare kerneldriver
        run: |
          if [ ! -d "./code" ]; then echo "::error::./code not found"; exit 1; fi
          mkdir kerneldriver
          cp -r ./code/* kerneldriver/

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git curl

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Initialize Repo (Manifest)
        run: |
          mkdir -p android-kernel && cd android-kernel
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 1. 初始化环境，还是得用对应的 Android 分支 (获取工具链配置)
          BRANCH="common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}"
          echo "Initializing Manifest Branch: $BRANCH"
          
          repo init -u https://android.googlesource.com/kernel/manifest -b $BRANCH --depth=1
          
          # 2. 同步除了内核源码以外的工具 (构建脚本、预编译工具链等)
          # common 目录是内核源码，我们稍后单独处理它，所以这里主要为了同步环境
          repo sync -c -j$(nproc) --no-tags --optimized-fetch

      - name: Checkout Specific Kernel Version
        run: |
          cd android-kernel/common
          
          TARGET="${{ github.event.inputs.target_tag }}"
          echo "Switching Kernel Source to: $TARGET"
          
          # 技巧：直接从 Google 远程 Fetch 指定的 TAG，而不需要下载整个历史记录
          # 这样既能切到指定版本，速度又快
          git fetch https://android.googlesource.com/kernel/common "refs/tags/$TARGET" --depth=1 || \
          git fetch https://android.googlesource.com/kernel/common "$TARGET" --depth=1
          
          # 切换到刚才 Fetch 下来的代码状态
          git checkout FETCH_HEAD
          
          echo "Current Kernel Head:"
          git show --oneline -s

      - name: Integrate Driver & Configure
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers/
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile
          
          # 注册模块到 modules.bzl (针对 Android 15)
          if [ -f "common/modules.bzl" ]; then
             sed -i "/_COMMON_GKI_MODULES_LIST = \[/a \    \"drivers/kerneldriver/${{ github.event.inputs.driver_name }}\"," common/modules.bzl
          fi
          
          # 增加栈大小防止报错
          find common -name "Makefile" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +

      - name: Build Kernel (Bazel)
        run: |
          cd android-kernel
          echo "Building for tag: ${{ github.event.inputs.target_tag }}"
          
          # 使用 Bazel 构建
          tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist \
            -- --dist_dir=out/dist --allow_undeclared_modules --lto=thin

      - name: Locate and Upload Artifacts
        if: always()
        run: |
          cd android-kernel
          mkdir -p final_output
          find . -type f -name "*.ko" -exec cp -v {} final_output/ \;
          find out/dist -type f -name "System.map" -exec cp -v {} final_output/ \; || true
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: driver-${{ github.event.inputs.target_tag }}
          path: android-kernel/final_output/*            echo "Source files moved."
          else
            echo "Error: ./code directory not found!"
            exit 1
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git curl

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Initialize and Sync Kernel Source
        run: |
          mkdir -p android-kernel && cd android-kernel
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          BRANCH="common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}"
          echo "Syncing branch: $BRANCH"
          
          repo init -u https://android.googlesource.com/kernel/manifest -b $BRANCH --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --optimized-fetch --prune

      - name: Modify Kernel Source to include Driver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers/
          
          # 将驱动加入 drivers/Makefile，这样 Bazel 构建整个内核时会包含它
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile
          
          # 尝试注入 GKI 模块列表 (可选，针对 Bazel)
          if [ -f "common/modules.bzl" ]; then
             sed -i "/_COMMON_GKI_MODULES_LIST = \[/a \    \"drivers/kerneldriver/${{ github.event.inputs.driver_name }}\"," common/modules.bzl
          fi

      - name: Build with Bazel (Kleaf)
        id: build_step
        run: |
          cd android-kernel
          echo "Starting Build..."
          
          # 使用这一行命令构建。如果 C 代码有错，这里会直接报错退出
          # 我们加上 --keep_going 尝试尽可能多地构建
          tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist \
            -- --dist_dir=out/dist --allow_undeclared_modules || echo "Bazel build failed, checking for partial artifacts..."

      - name: Locate and Stage Artifacts
        run: |
          cd android-kernel
          mkdir -p final_artifacts
          
          echo "Searching for .ko files..."
          # 使用 find 暴力查找生成的驱动文件，忽略路径差异
          find . -type f -name "*.ko" -exec cp {} final_artifacts/ \;
          find out/dist -type f -name "System.map" -exec cp {} final_artifacts/ \; || true
          
          echo "Contents of final_artifacts:"
          ls -la final_artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: driver-build-${{ github.event.inputs.kernel_version }}
          path: android-kernel/final_artifacts/*
          if-no-files-found: warn
